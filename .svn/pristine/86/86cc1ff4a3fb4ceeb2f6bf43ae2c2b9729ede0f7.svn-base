var actuatorServletPath = "../actuator";
var sensorServletPath = "../sensor";

var sensorList = [];


var modalKeyboard;

var manualDuration = 30;
var targetTemperature = 22.0;
var activeSensorId = 0;
var activeSensorName = "";
var localSensor = true;

var $activeProgram;


function onTargetButtonClicked(event) {
    targetTemperature = targetTemperature + event.data.param1;
    targetTemperature = +targetTemperature.toFixed(1);

    updateManualProgram();
}
function onDurationButtonClicked(event) {
    manualDuration = manualDuration + event.data.param1 * 60;
    //manualDuration = +targetTemperature.toFixed(1);

    updateManualProgram();
}

function pad(str, max, padder) {
    padder = typeof padder === "undefined" ? "0" : padder;
    return str.toString().length < max ? pad(padder.toString() + str, max, padder) : str;
}


function updateManualProgram() {

    $('t[name="targettemperature"]').text(targetTemperature);

    hour = manualDuration / 3600;
    hour = (hour - 0.5).toFixed(0);
    minute = manualDuration / 60 % 60;

    $('t[name="duration"]').text(pad(hour, 2) + ":" + pad(minute, 2));

    $('label[id="activesensor"]').text(activeSensorName + "(id: " + activeSensorId + ")");


}

function loadSensors() {

    $.getJSON(sensorServletPath, function (sensors) {

        $.each(sensors, function (id, sensor) {

                sensorList.push({id: id, description: sensor.name});
            })
            .done(function () {
                console.log("sensors loaded");
            })
            .fail(function () {
                console.log("error1");
            });
    });
}

function loadActuator(id) {

    $.getJSON(actuatorServletPath + '?id=1', function (actuator) {
            console.log("success");

            targetTemperature = actuator.target;
            targetTemperature = +targetTemperature.toFixed(1);
            manualDuration = actuator.duration;
            localSensor = actuator.localsensor;


            temp = actuator.temperature;
            localtemperature = +temp.toFixed(1);
            temp = actuator.remotetemperature;
            remotetemperature = +temp.toFixed(1);

            if (actuator.localsensor) {
                $('t[name="sensor"]').text("locale");
                $('label[name="currenttemperature"]').text(localtemperature + "째");
            } else {
                $('t[name="sensor"]').text("remoto");
                $('t[name="currenttemperature"]').text(remotetemperature + "째");
            }
            $('t[name="localtemperature"]').text(localtemperature + "째");
            $('t[name="remotetemperature"]').text(remotetemperature + "째");

            $('i[name="relestatusimage"]').removeClass("icon-rele-on icon-rele-off");
            if (actuator.relestatus) {
                $('i[name="relestatusimage"]').addClass("icon-rele-on");
                $('t[name="relestatus"]').text("Acceso");
            } else {
                $('i[name="relestatusimage"]').addClass("icon-rele-off");
                $('t[name="relestatus"]').text("Spento");
            }

            $('i[name="statusimage"]').removeClass("icon-hand-hold icon-magic icon-idle");
            if (actuator.status = "program") {
                $('i[name="statusimage"]').addClass("icon-magic");
                $('t[name="status"]').text("Programma");
            } else if (actuator.status = "manual") {
                $('i[name="statusimage"]').addClass("icon-hand-hold");
                $('t[name="status"]').text("Manuale");
            } else if (actuator.status = "idle") {
                $('i[name="statusimage"]').addClass("icon-idle");
                $('t[name="status"]').text("Idle");
            }


        })
        .done(function () {
            console.log("succes");
        })
        .fail(function () {
            console.log("error1");
            alert("error1");
        })
        .always(function () {
            console.log("error2");
        });
    //return res;
}
function loadActiveProgramList() {

    loadActiveProgram();


    var res;

    $.getJSON(programServletPath + '?next=true', function (data) {
            console.log("success");

            tr = $activeProgram.find('tr[name="activeprogram"]');
            res = data;

        })
        .done(function () {
            console.log("succes");
        })
        .fail(function () {
            console.log("error1");
            alert("error1");
        })
        .always(function () {
            console.log("error2");
        });

    return res;
}
function loadActiveProgram() {
    $.getJSON(programServletPath + '?active=true', function (data) {
            console.log("success");

            tr = $("#lastprogramupdate");
            tr.text(data.lastupdate);

        })
        .done(function () {
            console.log("succes");
        })
        .fail(function () {
            //console.log("error1");
        })
        .always(function () {
            console.log("error2");
        });
}
var modal;

function modalKeypad(div, title, items) {

    modal = div;
    var event = onSelectSensorClicked;

    $.get("numericKeypad.html", function (data) {

            modal.html(data);
            modal.css("display", "block");

            modal.find('p').text(title);

            item = modal.find('a');
            items.forEach(function (elem, index) {

                    last = item;

                    if (index > 0) {
                        //last = item;
                        item = item.clone();
                        last.last().after(item);

                    } else {
                        item = item;
                    }


                    //id = 1;
                    item.attr("id", elem.id);
                    item.text(elem.description);
                    item.on('click', {id: elem.id, description: elem.description}, event)
                        .on('mouseup', function () {
                            modal.css("display", "none");
                        });
                }
            );


            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];
            // When the user clicks on <span> (x), close the modal
            span.onclick = function () {
                //modal.style.display = "none";
                modal.css("display", "none");
                //selectsensor
            }
            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == modal) {
                    //modal.style.display = "none";
                    modal.css("display", "none");
                }
            }
        }
    )
    ;
}

function onSelectSensorClicked(event) {

    //alert(event.data.id);

    activeSensorId = event.data.id;
    activeSensorName = event.data.description;

    updateManualProgram();
}

function load() {

    loadSensors();
    actuator = loadActuator(1);



    $('button[id="selectsensor"]').on('click', function () {
        div = $('div[id="selectSensorModal"]');
        var items = [{id: 1, description: "xxx"}, {id: 2, description: "yyy"}, {id: 3, description: "zzz"}];
        modalKeypad(div, "titolo della finestra", sensorList);
    });

    $('a[name="targetplus"]').click({param1: 0.1, param2: "World"}, onTargetButtonClicked);
    $('a[name="targetminus"]').click({param1: -0.1, param2: "World"}, onTargetButtonClicked);

    $('a[name="durationplus"]').click({param1: 10, param2: "World"}, onDurationButtonClicked);
    $('a[name="durationminus"]').click({param1: -10, param2: "World"}, onDurationButtonClicked);




}